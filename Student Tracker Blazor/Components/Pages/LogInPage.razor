@page "/loginpage"
@rendermode InteractiveServer
@using Student_Tracker_Blazor


<div class="login-container">
    <h2>LOGIN</h2>

    <EditForm Model="@loginModel" OnValidSubmit="HandleLogin">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="input-group" >
            <label>Email</label>
            <InputText @bind-Value="loginModel.email" placeholder="Enter your email" />
        </div>

        <div class="input-group">
            <label>Password</label>
            <InputText @bind-Value="loginModel.password" type="password" placeholder="Enter your password" />
        </div>

        <button type="submit">LOGIN</button>

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="alert" alert-success mt-3>
                @message
            </div>
        }
    </EditForm>
</div>

@code {
    private LoginModel loginModel = new();
    private Login loginHandler = new();
    private string? message;

    private async Task HandleLogin()
    {
        UserJson? currentUser = await APIServices.LoginUserAsync(loginModel.email, loginModel.password);

        if (currentUser == null)
        {
            message = "Error: incorrect login! Please try again.";

            StateHasChanged();

            await Task.Delay(5000);

            message = null;
            StateHasChanged();

            //reset form
            loginModel = new();

            UserJson user = new UserJson();
            user.password = "Password";
            Console.WriteLine(user.password);
            user.HashPassword();
            Console.WriteLine(user.password);

            Console.WriteLine(loginModel.email, loginModel.password);
            user.password = loginModel.password;
            user.HashPassword();
            Console.WriteLine(user.password);
        }
        else
        {
            message = $"Welcome, {currentUser.firstName}!";

            loginHandler.LogInUser(currentUser);

            StateHasChanged();

            await Task.Delay(5000);

            message = null;
            StateHasChanged();

            //reset form
            loginModel = new();

            Console.WriteLine($"Current user: {loginHandler.currentUser}");  //debug lines, delete
        }
    }

    public class LoginModel
    {
        public string email { get; set; } = string.Empty;
        public string password { get; set; } = string.Empty;
    }
}

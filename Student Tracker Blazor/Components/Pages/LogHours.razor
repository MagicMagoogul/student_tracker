@* @page "/loghours"
@rendermode InteractiveServer
@using Student_Tracker_Blazor
@inject Login loginHandler;


<PageTitle>Log Hours</PageTitle>

<h1>Log Hours</h1>

<div class="container mt-5">
    <EditForm Model="@logHoursModel" OnValidSubmit="PushLogHours">

        <div class="row">
            <div class="col-md-6">
                <label>Hours</label>
                <InputText @bind-Value="logHoursModel.hours" placeholder="Enter hours" />
            </div>

            <div class="col-md-6">
                <label>Location</label>
                <InputText @bind-Value="logHoursModel.location" placeholder="Enter location" />
            </div>

            <div class="col-md-6">
                <label>Date</label>
                <InputText @bind-Value="logHoursModel.shiftDate" placeholder="Enter date of the shift" />
            </div>
        </div>

        <button class="mb-3" type="submit">Submit Hours</button>

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert" alert-success mt-3>
                @successMessage
            </div>    
        }
    </EditForm>

</div>

@code
{
    private LogHoursModel logHoursModel = new();
    private HoursLoggedJson hoursLoggedJson = new();
    private string? successMessage;

    private async Task PushLogHours()
    {
        hoursLoggedJson.studentId = logHoursModel.studentId;
        hoursLoggedJson.hours = logHoursModel.hours;
        hoursLoggedJson.location = logHoursModel.location;
        hoursLoggedJson.shiftDate = logHoursModel.shiftDate;
        hoursLoggedJson.loggingDate = logHoursModel.loggingDate;

        //push form info to HoursLogged db table
        await APIServices.CreateHoursLoggedAsync(hoursLoggedJson);   

        //show message for 5 seconds and then hide again
        successMessage = "Hours successfully logged!";
        StateHasChanged();

        await Task.Delay(5000);

        successMessage = null;
        StateHasChanged();

        //reset form
        logHoursModel = new();
    }

    public class LogHoursModel
    {
        public Login login { get; set; } 
        public int studentId { get; set; }
        public string hours { get; set; }
        public string location { get; set; }
        public string shiftDate { get; set; }
        public string loggingDate { get; set; }

        public LogHoursModel()
        {
            studentId = login.currentUser.userId;
            loggingDate = DateTime.Today.ToString();
        }
    }
} *@

@page "/loghours"
@rendermode InteractiveServer
@using Student_Tracker_Blazor

@inject Login loginHandler

<PageTitle>Log Hours</PageTitle>

<h1>Log Hours</h1>

<div class="container mt-5">
    <EditForm Model="@logHoursModel" OnValidSubmit="PushLogHours">

        <div class="row">
            <div class="col-md-6">
                <label>Hours</label>
                <InputText @bind-Value="logHoursModel.hours" placeholder="Enter hours" />
            </div>

            <div class="col-md-6">
                <label>Location</label>
                <InputText @bind-Value="logHoursModel.location" placeholder="Enter location" />
            </div>

            <div class="col-md-6">
                <label>Date</label>
                <InputText @bind-Value="logHoursModel.shiftDate" placeholder="Enter date of the shift" />
            </div>
        </div>

        <button class="mb-3" type="submit">Submit Hours</button>

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success mt-3">
                @successMessage
            </div>
        }
    </EditForm>
</div>

@code
{
    private LogHoursModel logHoursModel = new();
    private HoursLoggedJson hoursLoggedJson = new();
    private string? successMessage;

    protected override void OnInitialized()
    {
        // Initialize model AFTER loginHandler is injected
        logHoursModel = new LogHoursModel
        {
            login = loginHandler,
            studentId = loginHandler.currentUser?.userId ?? 0,
            loggingDate = DateTime.Today.ToString()
        };
    }

    private async Task PushLogHours()
    {
        hoursLoggedJson.studentId = logHoursModel.studentId;
        hoursLoggedJson.hours = logHoursModel.hours;
        hoursLoggedJson.location = logHoursModel.location;
        hoursLoggedJson.shiftDate = logHoursModel.shiftDate;
        hoursLoggedJson.loggingDate = logHoursModel.loggingDate;

        await APIServices.CreateHoursLoggedAsync(hoursLoggedJson);   

        successMessage = "Hours successfully logged!";
        StateHasChanged();

        await Task.Delay(5000);

        successMessage = null;
        StateHasChanged();

        // Reset form but keep studentId & loggingDate
        logHoursModel = new LogHoursModel
        {
            login = loginHandler,
            studentId = loginHandler.currentUser?.userId ?? 0,
            loggingDate = DateTime.Today.ToString()
        };
    }

    public class LogHoursModel
    {
        public Login login { get; set; }
        public int studentId { get; set; }
        public string hours { get; set; }
        public string location { get; set; }
        public string shiftDate { get; set; }
        public string loggingDate { get; set; }

        // No constructor logic — Blazor DI cannot inject values into constructors
    }
}


